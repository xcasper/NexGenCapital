var ListFieldsElement=new Class({Implements:[Options,Events],options:{conn:null,highlightpk:false,showAll:1,mode:"dropdown"},initialize:function(b,a){this.strEl=b;this.el=b;this.setOptions(a);if(typeOf(document.id(this.options.conn))==="null"){this.cnnperiodical=this.getCnn.periodical(500,this)}else{this.setUp()}},cloned:function(b,a){this.strEl=b;this.el=document.id(b);this._cloneProp("conn",a);this._cloneProp("table",a);this.setUp()},_cloneProp:function(c,a){var b=this.options[c].split("-");b=b.splice(0,b.length-1);b.push(a);this.options[c]=b.join("-")},getCnn:function(){if(typeOf(document.id(this.options.conn))==="null"){return}this.setUp();clearInterval(this.cnnperiodical)},setUp:function(){this.el=document.id(this.el);if(this.options.mode==="gui"){this.select=this.el.getParent().getElement("select.elements")}document.id(this.options.conn).addEvent("change",function(){this.updateMe()}.bind(this));document.id(this.options.table).addEvent("change",function(){this.updateMe()}.bind(this));var a=document.id(this.options.conn).get("value");if(a!==""&&a!==-1){this.periodical=this.updateMe.periodical(500,this)}var b=this.el.getParent().getElement("button");if(typeOf(b)!=="null"){b.addEvent("mousedown",function(c){c.stop();this.addPlaceHolder()}.bind(this));b.addEvent("click",function(c){c.stop()})}},updateMe:function(e){if(typeOf(e)==="event"){e.stop()}if(document.id(this.el.id+"_loader")){document.id(this.el.id+"_loader").show()}var cid=document.id(this.options.conn).get("value");var tid=document.id(this.options.table).get("value");if(!tid){return}clearInterval(this.periodical);var url="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=element&plugin=field&method=ajax_fields&showall="+this.options.showAll+"&cid="+cid+"&t="+tid;var myAjax=new Request({url:url,method:"get",data:{highlightpk:this.options.highlightpk,k:2},onComplete:function(r){var els;if(typeOf(document.id(this.strEl))!==null){this.el=document.id(this.strEl)}if(this.options.mode==="gui"){els=[this.select]}else{els=document.getElementsByName(this.el.name);this.el.empty();document.id(this.strEl).empty()}var opts=eval(r);Array.each(els,function(el){document.id(el).empty()});opts.each(function(opt){var o={value:opt.value};if(opt.value===this.options.value){o.selected="selected"}Array.each(els,function(el){new Element("option",o).set("text",opt.label).inject(el)})}.bind(this));if(document.id(this.el.id+"_loader")){document.id(this.el.id+"_loader").hide()}}.bind(this)});Fabrik.requestQueue.add(myAjax)},addPlaceHolder:function(){var a=this.el.getParent().getElement("select");this.insertTextAtCaret(this.el,a.get("value"))},getSelectionBoundary:function(c,b){var h=b?"selectionStart":"selectionEnd";var g,i,a,f,e;if(typeof c[h]==="number"){return c[h]}else{if(document.selection&&document.selection.createRange){c.focus();var d=document.selection.createRange();if(d){if(document.selection.type==="Text"){d.collapse(!!b)}g=c.value;i=c.createTextRange();a=c.createTextRange();f=0;e=d.getBookmark();i.moveToBookmark(e);if(g.indexOf("\r\n")>-1){i.text=" ";a.setEndPoint("EndToStart",i);f=a.text.length-1;document.execCommand("undo")}else{a.setEndPoint("EndToStart",i);f=a.text.length}return f}}}return 0},offsetToRangeCharacterMove:function(a,b){return b-(a.value.slice(0,b).split("\r\n").length-1)},setSelection:function(e,a,d){var c=e.createTextRange();var b=this.offsetToRangeCharacterMove(e,a);c.collapse(true);if(a===d){c.move("character",b)}else{c.moveEnd("character",this.offsetToRangeCharacterMove(e,d));c.moveStart("character",b)}c.select()},insertTextAtCaret:function(b,d){var e=this.getSelectionBoundary(b,false);var a=e+d.length;var c=b.value;b.value=c.slice(0,e)+d+c.slice(e);this.setSelection(b,a,a)}});