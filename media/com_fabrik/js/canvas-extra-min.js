(function(){CanvasRenderingContext2D.prototype.__defineGetter__("width",function(){return this.canvas.width});CanvasRenderingContext2D.prototype.__defineGetter__("height",function(){return this.canvas.height});CanvasRenderingContext2D.prototype.blackAndWhite=function(){var h=this.getImageData(0,0,this.width,this.height);for(var d=0;d<h.data.length;d+=4){var f=h.data[d+0];var e=h.data[d+1];var a=h.data[d+2];var c=f+e+a;c/=3;h.data[d+0]=c;h.data[d+1]=c;h.data[d+2]=c}this.putImageData(h,0,0)};CanvasRenderingContext2D.prototype.flipVertically=function(){this.save();this.scale(1,-1);this.translate(0,-this.height);this.drawImage(this.canvas,0,0);this.restore()};CanvasRenderingContext2D.prototype.flipHorizontally=function(){this.save();this.scale(-1,1);this.translate(-this.width,0);this.drawImage(this.canvas,0,0);this.restore()};CanvasRenderingContext2D.prototype.turn=function(c){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;b.style.display="none";document.body.appendChild(b);b.getContext("2d").drawImage(this.canvas,0,0);this.canvas.width=b.height;this.canvas.height=b.width;this.save();if(c){this.translate(this.width,0)}else{this.translate(0,this.height)}var a=Math.PI/2;if(!c){a*=-1}this.rotate(a);this.drawImage(b,0,0);this.restore();document.body.removeChild(b)};CanvasRenderingContext2D.prototype.resize=function(b){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;a.style.display="none";document.body.appendChild(a);a.getContext("2d").drawImage(this.canvas,0,0);this.canvas.width*=b;this.canvas.height*=b;this.save();this.scale(b,b);this.drawImage(a,0,0);document.body.removeChild(a);this.restore()};CanvasRenderingContext2D.prototype.isPortrait=function(){return this.width<this.height};CanvasRenderingContext2D.prototype._urlDropped=function(d,a,f,e){var c=this;var b=document.createElement("img");b.style.display="none";b.addEventListener("load",function(){var h;var g=1;var i=1;if(b.width>c.width/3){g=(c.width/3)/b.width}if(b.height>c.height/3){i=(c.height/3)/b.height}h=Math.min(g,i);c.save();c.translate(a-b.width*h/2,f-b.height*h/2);c.scale(h,h);c.drawImage(b,0,0);if(e){c.strokeStyle="white";c.lineWidth=5/h;c.strokeRect(0,0,b.width,b.height)}c.restore();document.body.removeChild(b)},true);b.src=d;document.body.appendChild(b)};CanvasRenderingContext2D.prototype.initDnD=function(){var a=this;this.canvas.addEventListener("dragover",function(b){b.preventDefault()},true);this.canvas.addEventListener("drop",function(g){g.preventDefault();var c=g.dataTransfer;var j=g.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;var h=g.clientY+document.body.scrollTop+document.documentElement.scrollTop;var l=j-a.canvas.offsetLeft-a.canvas.parentNode.offsetLeft;var k=h-a.canvas.offsetTop-a.canvas.parentNode.offsetTop;var b=c.files;if(b.length===0){var i="application/x-moz-file-promise-url";if(c.types.contains(i)){a._urlDropped(c.getData(i),l,k,false)}}else{var d=b[0];var f=new FileReader();f.onload=function(m){a._urlDropped(m.target.result,l,k,true)};f.readAsDataURL(d)}},true)};CanvasRenderingContext2D.prototype.poster=function(c){var b=Math.min(this.width,this.height);b/=10;this.fillStyle="black";this.fillRect(0,0,this.width,b);this.fillRect(0,this.height-2*b,this.width,2*b);this.fillRect(0,0,b,this.height);this.fillRect(this.width-b,0,b,this.height);this.strokeStyle="white";var a=5;this.strokeRect(b-a,b-a,this.width-(b*2)+2*a,this.height-(b*3)+2*a);this.fillStyle="white";this.textAlign="center";this.textBaseline="middle";this.font=b+"px marketing";this.fillText(c,this.width/2,this.height-b,this.width)};CanvasRenderingContext2D.prototype.initCrop=function(){if(isMobile){this.initCrop_mobile()}else{this.initCrop_desktop()}};CanvasRenderingContext2D.prototype.initCrop_mobile=function(){var f,e;var b=this;var a=this.canvas;function d(g){f=g.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;e=g.clientY+document.body.scrollTop+document.documentElement.scrollTop;a.removeEventListener("click",d,true);a.addEventListener("click",c,true)}function c(j){a.removeEventListener("click",c,true);var h=j.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;var k=j.clientY+document.body.scrollTop+document.documentElement.scrollTop;var i=h-f;var g=k-e;h=f;k=e;if(i<0){h+=i;i*=-1}if(g<0){k+=g;g*=-1}h-=a.offsetLeft+a.parentNode.offsetLeft;k-=a.offsetTop+a.parentNode.offsetTop;b.crop(h,k,i,g)}a.addEventListener("click",d,true)};CanvasRenderingContext2D.prototype.initCrop_desktop=function(){var g=document.createElement("div");g.id="cropbox";g.style.display="none";document.body.appendChild(g);var h,f;var b=this;var a=this.canvas;function c(i){h=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;f=i.clientY+document.body.scrollTop+document.documentElement.scrollTop;a.addEventListener("mousemove",d,true)}function e(l){a.removeEventListener("mousemove",d,true);a.removeEventListener("mousedown",c,true);a.removeEventListener("mouseup",e,true);var j=g.offsetLeft-a.offsetLeft-a.parentNode.offsetLeft;var m=g.offsetTop-a.offsetTop-a.parentNode.offsetTop;var k=g.offsetWidth;var i=g.offsetHeight;document.body.removeChild(g);b.crop(j,m,k,i)}function d(m){var k=m.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;var o=m.clientY+document.body.scrollTop+document.documentElement.scrollTop;var j=h;var n=f;var l=k-h;var i=o-f;if(l<0){j+=l;l*=-1}if(i<0){n+=i;i*=-1}g.style.display="block";g.style.left=j+"px";g.style.top=n+"px";g.style.width=l+"px";g.style.height=i+"px"}a.addEventListener("mousedown",c,true);a.addEventListener("mouseup",e,true)};CanvasRenderingContext2D.prototype.crop=function(c,e,d,b){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;a.style.display="none";document.body.appendChild(a);a.getContext("2d").drawImage(this.canvas,0,0);this.canvas.width=d;this.canvas.height=b;this.save();this.drawImage(a,-c,-e);this.restore();document.body.removeChild(a)}}());